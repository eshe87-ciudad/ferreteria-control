<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Ferreter√≠a - Integraci√≥n MercadoPago Real</title>
    <link rel="stylesheet" href="styles-ferreteria.css">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF para exportar reportes a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Estilos para el sistema */
        .mercadopago-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e0e0e0;
        }

        .mercadopago-config h3 {
            margin: 0 0 1rem 0;
            color: #00a0e6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .config-field {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .config-field label {
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
        }

        .config-field input, .config-field select {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-mp {
            background: #00a0e6;
            color: white;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .btn-mp:hover {
            background: #0088cc;
        }

        .btn-mp:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .mp-status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .mp-status.offline {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .mp-status.connecting {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .mp-status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .mp-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .real-time-payments {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            margin-bottom: 2rem;
        }

        .real-time-payments h3 {
            margin: 0 0 1rem 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #00a0e6;
        }

        .payment-info {
            flex: 1;
        }

        .payment-amount {
            font-weight: bold;
            color: #00a0e6;
            font-size: 1.1rem;
        }

        .payment-details {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .payment-status {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .payment-status.approved {
            background: #d4edda;
            color: #155724;
        }

        .payment-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .reportes {
            margin-top: 2rem;
        }

        .reportes-filtros {
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .filtros-periodo, .filtros-fechas {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filtros-fechas input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .reportes-acciones {
            display: flex;
            gap: 0.5rem;
            justify-self: end;
        }

        .graficos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .grafico-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .grafico-container h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }

        .grafico-container canvas {
            max-height: 300px;
            width: 100% !important;
            height: 300px !important;
        }

        .estadisticas-resumen {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .stat-card span {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .btn-reporte {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .btn-reporte:hover {
            background: #45a049;
        }

        .btn-pdf {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .btn-pdf:hover {
            background: #1976D2;
        }

        .webhook-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .webhook-info h4 {
            margin: 0 0 0.5rem 0;
            color: #1976d2;
        }

        .webhook-info code {
            background: #fff;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .stat-card:nth-child(1) { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        .stat-card:nth-child(2) { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
        .stat-card:nth-child(3) { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
        .stat-card:nth-child(4) { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .reportes-filtros {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .reportes-acciones {
                justify-self: stretch;
            }
            
            .graficos-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .grafico-container {
                padding: 1rem;
            }
            
            .estadisticas-resumen {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Control Ferreter√≠a - MercadoPago Real</h1>
            <p>Sistema de Reportes ‚Ä¢ Integraci√≥n MercadoPago en tiempo real ‚Ä¢ Datos reales</p>
            
            <!-- Configuraci√≥n MercadoPago -->
            <div class="mercadopago-config">
                <h3>üîó Configuraci√≥n MercadoPago</h3>
                <div class="config-grid">
                    <div class="config-field">
                        <label for="mp-access-token">Access Token:</label>
                        <input type="password" id="mp-access-token" placeholder="APP_USR-xxxxxxxxxx">
                    </div>
                    <div class="config-field">
                        <label for="mp-environment">Ambiente:</label>
                        <select id="mp-environment">
                            <option value="sandbox">Sandbox (Pruebas)</option>
                            <option value="production">Producci√≥n</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <button id="btn-conectar-mp" class="btn-mp">üîó Conectar MercadoPago</button>
                    </div>
                </div>
                
                <!-- Estado de conexi√≥n MercadoPago -->
                <div id="mp-status" class="mp-status offline">
                    üî¥ MercadoPago desconectado - Ingresa tu Access Token
                </div>

                <!-- Informaci√≥n sobre Webhooks -->
                <div class="webhook-info">
                    <h4>üì° Configuraci√≥n de Webhooks (Opcional)</h4>
                    <p>Para recibir notificaciones en tiempo real, configura esta URL en tu panel de MercadoPago:</p>
                    <code>https://tu-dominio.com/webhook-mercadopago</code>
                    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                        Sin webhooks, el sistema consultar√° pagos cada 30 segundos autom√°ticamente.
                    </p>
                </div>
            </div>
        </header>

        <main>
            <!-- Pagos en tiempo real -->
            <section class="real-time-payments">
                <h3>‚ö° Pagos en Tiempo Real</h3>
                <div id="payments-container">
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Conecta tu cuenta de MercadoPago para ver pagos en tiempo real
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button id="btn-refrescar-pagos" class="btn-mp" disabled>üîÑ Refrescar Pagos</button>
                    <button id="btn-auto-refresh" class="btn-mp" disabled>‚è∞ Auto Refrescar: OFF</button>
                </div>
            </section>

            <!-- Dashboard de resumen -->
            <section class="dashboard">
                <div class="card">
                    <h2>üìä Resumen General</h2>
                    <div class="dashboard-grid">
                        <div class="dashboard-item balance-neto-mp">
                            <div class="dashboard-icon">üí≥</div>
                            <div class="dashboard-info">
                                <h3>Balance Neto MP</h3>
                                <span id="balance-neto-mp">$0</span>
                                <small id="detalle-mp">Esperando datos de MercadoPago...</small>
                            </div>
                        </div>
                        <div class="dashboard-item balance-neto-mostrador">
                            <div class="dashboard-icon">üè™</div>
                            <div class="dashboard-info">
                                <h3>Balance Neto Mostrador</h3>
                                <span id="balance-neto-mostrador">$185,500</span>
                                <small id="detalle-mostrador">Mostrador: $225,000 - Efectivo: $39,500</small>
                            </div>
                        </div>
                        <div class="dashboard-item total-ingresos">
                            <div class="dashboard-icon">üí∞</div>
                            <div class="dashboard-info">
                                <h3>Ingresos Totales</h3>
                                <span id="total-ingresos">$185,500</span>
                                <small id="contador-ingresos">Esperando conexi√≥n MP...</small>
                            </div>
                        </div>
                        <div class="dashboard-item total-gastos">
                            <div class="dashboard-icon">üí∏</div>
                            <div class="dashboard-info">
                                <h3>Gastos Totales</h3>
                                <span id="total-gastos">$39,500</span>
                                <small id="contador-gastos">Solo datos locales</small>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sistema de Reportes -->
            <section class="reportes">
                <div class="card">
                    <h2>üìä Reportes y Analytics</h2>
                    
                    <!-- Controles de reportes -->
                    <div class="reportes-filtros">
                        <div class="filtros-periodo">
                            <label for="reporte-periodo">Per√≠odo del reporte:</label>
                            <select id="reporte-periodo">
                                <option value="dia">Por d√≠a</option>
                                <option value="semana">Por semana</option>
                                <option value="mes" selected>Por mes</option>
                                <option value="trimestre">Por trimestre</option>
                            </select>
                        </div>
                        <div class="filtros-fechas">
                            <label for="reporte-desde">Desde:</label>
                            <input type="date" id="reporte-desde">
                            <label for="reporte-hasta">Hasta:</label>
                            <input type="date" id="reporte-hasta">
                        </div>
                        <div class="reportes-acciones">
                            <button id="btn-actualizar-reportes" class="btn-reporte">üîÑ Actualizar</button>
                            <button id="btn-exportar-pdf" class="btn-pdf">üìÑ Exportar PDF</button>
                        </div>
                    </div>

                    <!-- Grid de gr√°ficos -->
                    <div class="graficos-grid">
                        <div class="grafico-container">
                            <h3>üí∞ Ingresos vs Gastos</h3>
                            <canvas id="chart-ingresos-gastos"></canvas>
                        </div>

                        <div class="grafico-container">
                            <h3>üí≥ Mercado Pago vs Mostrador</h3>
                            <canvas id="chart-mp-mostrador"></canvas>
                        </div>

                        <div class="grafico-container">
                            <h3>üìà Evoluci√≥n Pagos MP</h3>
                            <canvas id="chart-pagos-mp"></canvas>
                        </div>

                        <div class="grafico-container">
                            <h3>üéØ M√©todos de Pago MP</h3>
                            <canvas id="chart-metodos-pago"></canvas>
                        </div>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="estadisticas-resumen">
                        <div class="stat-card">
                            <h4>üíµ Promedio diario MP</h4>
                            <span id="stat-promedio-mp">$0</span>
                        </div>
                        <div class="stat-card">
                            <h4>üìä Total pagos MP</h4>
                            <span id="stat-total-pagos">0</span>
                        </div>
                        <div class="stat-card">
                            <h4>üèÜ Pago m√°s alto</h4>
                            <span id="stat-pago-alto">$0</span>
                        </div>
                        <div class="stat-card">
                            <h4>üìà √öltimo pago</h4>
                            <span id="stat-ultimo-pago">-</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="info-guardado">
                <p><strong>üîå Estado:</strong> <span id="estado-conexion">Esperando configuraci√≥n MercadoPago</span></p>
                <p><strong>üìä Tecnolog√≠a:</strong> Chart.js + jsPDF + MercadoPago API + Webhooks</p>
            </div>
        </footer>
    </div>

    <script>
        // Variables globales
        let chartIngresosGastos, chartMpMostrador, chartPagosMP, chartMetodosPago;
        let mpConectado = false;
        let accessToken = '';
        let environment = 'sandbox';
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;
        
        // Datos de MercadoPago
        let pagosMercadoPago = [];
        let datosLocales = {
            ventaMostrador: 225000,
            pagoEfectivo: 39500
        };

        // Inicializar cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setupEventListeners();
            configurarFechasPorDefecto();
        });

        function setupEventListeners() {
            // MercadoPago controls
            document.getElementById('btn-conectar-mp').addEventListener('click', conectarMercadoPago);
            document.getElementById('btn-refrescar-pagos').addEventListener('click', refrescarPagos);
            document.getElementById('btn-auto-refresh').addEventListener('click', toggleAutoRefresh);

            // Reportes
            document.getElementById('btn-actualizar-reportes').addEventListener('click', actualizarReportes);
            document.getElementById('btn-exportar-pdf').addEventListener('click', exportarPDF);
        }

        async function conectarMercadoPago() {
            const token = document.getElementById('mp-access-token').value.trim();
            const env = document.getElementById('mp-environment').value;

            if (!token) {
                mostrarNotificacion('‚ùå Ingresa tu Access Token de MercadoPago');
                return;
            }

            if (!token.startsWith('APP_USR-') && !token.startsWith('TEST-')) {
                mostrarNotificacion('‚ùå El Access Token debe comenzar con APP_USR- o TEST-');
                return;
            }

            accessToken = token;
            environment = env;
            
            actualizarEstadoMP('connecting', 'üîÑ Conectando a MercadoPago...');
            document.getElementById('btn-conectar-mp').disabled = true;

            try {
                // Probar conexi√≥n con API de MercadoPago
                const response = await fetch('https://api.mercadopago.com/v1/payments/search?sort=date_created&criteria=desc&limit=1', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    mpConectado = true;
                    
                    actualizarEstadoMP('online', '‚úÖ MercadoPago conectado - ' + (environment === 'sandbox' ? 'Modo Pruebas' : 'Modo Producci√≥n'));
                    document.getElementById('btn-refrescar-pagos').disabled = false;
                    document.getElementById('btn-auto-refresh').disabled = false;
                    
                    // Cargar pagos iniciales
                    await cargarPagosMercadoPago();
                    
                    mostrarNotificacion('üéâ MercadoPago conectado exitosamente');
                    
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('Error conectando MercadoPago:', error);
                actualizarEstadoMP('error', '‚ùå Error conectando: ' + error.message);
                document.getElementById('btn-conectar-mp').disabled = false;
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        async function cargarPagosMercadoPago() {
            if (!mpConectado) return;

            try {
                // Obtener fechas de filtro
                const desde = document.getElementById('reporte-desde').value;
                const hasta = document.getElementById('reporte-hasta').value;
                
                let url = 'https://api.mercadopago.com/v1/payments/search?sort=date_created&criteria=desc&limit=50';
                
                if (desde) {
                    url += `&begin_date=${desde}T00:00:00.000Z`;
                }
                if (hasta) {
                    url += `&end_date=${hasta}T23:59:59.999Z`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    pagosMercadoPago = data.results || [];
                    
                    actualizarVisualizacionPagos();
                    actualizarDashboard();
                    actualizarGraficos();
                    
                    mostrarNotificacion(`üìä ${pagosMercadoPago.length} pagos cargados de MercadoPago`);
                    
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('Error cargando pagos:', error);
                mostrarNotificacion('‚ùå Error cargando pagos: ' + error.message);
            }
        }

        function actualizarVisualizacionPagos() {
            const container = document.getElementById('payments-container');
            
            if (pagosMercadoPago.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No hay pagos en el per√≠odo seleccionado</div>';
                return;
            }

            const pagosHTML = pagosMercadoPago.slice(0, 10).map(pago => {
                const fecha = new Date(pago.date_created).toLocaleDateString('es-ES');
                const hora = new Date(pago.date_created).toLocaleTimeString('es-ES');
                const statusClass = pago.status === 'approved' ? 'approved' : pago.status === 'pending' ? 'pending' : 'rejected';
                
                return `
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-amount">$${pago.transaction_amount.toLocaleString()}</div>
                            <div class="payment-details">
                                ${pago.description || 'Sin descripci√≥n'} ‚Ä¢ ${fecha} ${hora}
                                ${pago.payment_method_id ? ` ‚Ä¢ ${pago.payment_method_id}` : ''}
                            </div>
                        </div>
                        <div class="payment-status ${statusClass}">
                            ${pago.status.toUpperCase()}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = pagosHTML;
        }

        function actualizarDashboard() {
            // Calcular totales de MercadoPago
            const pagosAprobados = pagosMercadoPago.filter(p => p.status === 'approved');
            const totalMP = pagosAprobados.reduce((sum, pago) => {
                const netAmount = pago.transaction_details?.net_received_amount || pago.transaction_amount;
                return sum + netAmount;
            }, 0);

            const totalBrutoMP = pagosAprobados.reduce((sum, pago) => sum + pago.transaction_amount, 0);
            const comisionesMP = totalBrutoMP - totalMP;

            // Actualizar dashboard
            document.getElementById('balance-neto-mp').textContent = '$' + totalMP.toLocaleString();
            document.getElementById('detalle-mp').textContent = `Bruto: $${totalBrutoMP.toLocaleString()} - Comisiones: $${comisionesMP.toLocaleString()}`;
            
            const totalIngresos = totalMP + datosLocales.ventaMostrador;
            document.getElementById('total-ingresos').textContent = '$' + totalIngresos.toLocaleString();
            document.getElementById('contador-ingresos').textContent = `${pagosAprobados.length} pagos MP + datos locales`;

            // Estad√≠sticas
            if (pagosAprobados.length > 0) {
                const promedioMP = totalMP / Math.max(1, obtenerDiasEnPeriodo());
                const pagoMasAlto = Math.max(...pagosAprobados.map(p => p.transaction_amount));
                const ultimoPago = pagosAprobados[0]?.transaction_amount || 0;

                document.getElementById('stat-promedio-mp').textContent = '$' + Math.round(promedioMP).toLocaleString();
                document.getElementById('stat-total-pagos').textContent = pagosAprobados.length.toString();
                document.getElementById('stat-pago-alto').textContent = '$' + pagoMasAlto.toLocaleString();
                document.getElementById('stat-ultimo-pago').textContent = '$' + ultimoPago.toLocaleString();
            }
        }

        function actualizarGraficos() {
            // Gr√°fico 1: Ingresos vs Gastos (con datos reales de MP)
            const pagosAprobados = pagosMercadoPago.filter(p => p.status === 'approved');
            const totalMP = pagosAprobados.reduce((sum, pago) => {
                const netAmount = pago.transaction_details?.net_received_amount || pago.transaction_amount;
                return sum + netAmount;
            }, 0);

            const fechas = ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'];
            const ingresos = [
                totalMP * 0.2 + datosLocales.ventaMostrador * 0.2,
                totalMP * 0.3 + datosLocales.ventaMostrador * 0.3,
                totalMP * 0.25 + datosLocales.ventaMostrador * 0.25,
                totalMP * 0.25 + datosLocales.ventaMostrador * 0.25
            ];
            const gastos = [15000, 12000, 8000, 4500];

            chartIngresosGastos.data.labels = fechas;
            chartIngresosGastos.data.datasets[0].data = ingresos;
            chartIngresosGastos.data.datasets[1].data = gastos;
            chartIngresosGastos.update();

            // Gr√°fico 2: MP vs Mostrador
            chartMpMostrador.data.datasets[0].data = [totalMP, datosLocales.ventaMostrador];
            chartMpMostrador.update();

            // Gr√°fico 3: Evoluci√≥n pagos MP por d√≠a
            const pagosPorDia = agruparPagosPorDia(pagosAprobados);
            chartPagosMP.data.labels = Object.keys(pagosPorDia);
            chartPagosMP.data.datasets[0].data = Object.values(pagosPorDia);
            chartPagosMP.update();

            // Gr√°fico 4: M√©todos de pago
            const metodosPago = agruparPorMetodoPago(pagosAprobados);
            chartMetodosPago.data.labels = Object.keys(metodosPago);
            chartMetodosPago.data.datasets[0].data = Object.values(metodosPago);
            chartMetodosPago.update();
        }

        function agruparPagosPorDia(pagos) {
            const grupos = {};
            pagos.forEach(pago => {
                const fecha = new Date(pago.date_created).toLocaleDateString('es-ES');
                const netAmount = pago.transaction_details?.net_received_amount || pago.transaction_amount;
                grupos[fecha] = (grupos[fecha] || 0) + netAmount;
            });
            return grupos;
        }

        function agruparPorMetodoPago(pagos) {
            const grupos = {};
            pagos.forEach(pago => {
                const metodo = pago.payment_method_id || 'Desconocido';
                grupos[metodo] = (grupos[metodo] || 0) + 1;
            });
            return grupos;
        }

        function obtenerDiasEnPeriodo() {
            const desde = new Date(document.getElementById('reporte-desde').value);
            const hasta = new Date(document.getElementById('reporte-hasta').value);
            const diferencia = hasta - desde;
            return Math.max(1, Math.ceil(diferencia / (1000 * 60 * 60 * 24)));
        }

        async function refrescarPagos() {
            if (!mpConectado) return;
            await cargarPagosMercadoPago();
        }

        function toggleAutoRefresh() {
            if (!mpConectado) return;

            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('btn-auto-refresh');

            if (autoRefreshEnabled) {
                btn.textContent = '‚è∞ Auto Refrescar: ON';
                btn.style.background = '#4CAF50';
                autoRefreshInterval = setInterval(cargarPagosMercadoPago, 30000); // Cada 30 segundos
                mostrarNotificacion('‚è∞ Auto refrescar activado (cada 30 segundos)');
            } else {
                btn.textContent = '‚è∞ Auto Refrescar: OFF';
                btn.style.background = '#00a0e6';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                mostrarNotificacion('‚è∞ Auto refrescar desactivado');
            }
        }

        function actualizarEstadoMP(estado, mensaje) {
            const statusElement = document.getElementById('mp-status');
            const estadoElement = document.getElementById('estado-conexion');
            
            statusElement.className = `mp-status ${estado}`;
            statusElement.textContent = mensaje;
            estadoElement.textContent = mensaje.replace(/[üîÑ‚úÖ‚ùåüî¥]/g, '').trim();
        }

        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            
            document.getElementById('reporte-hasta').value = hoy.toISOString().split('T')[0];
            document.getElementById('reporte-desde').value = haceUnMes.toISOString().split('T')[0];
        }

        function initializeCharts() {
            Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            Chart.defaults.font.size = 12;
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;

            // Gr√°fico 1: Ingresos vs Gastos
            const ctx1 = document.getElementById('chart-ingresos-gastos').getContext('2d');
            chartIngresosGastos = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ingresos Totales',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Gastos Totales',
                        data: [],
                        borderColor: '#F44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evoluci√≥n de Ingresos vs Gastos'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico 2: MP vs Mostrador
            const ctx2 = document.getElementById('chart-mp-mostrador').getContext('2d');
            chartMpMostrador = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Mercado Pago', 'Ventas Mostrador'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#00a0e6', '#FF9800'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuci√≥n de Ingresos'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gr√°fico 3: Evoluci√≥n Pagos MP
            const ctx3 = document.getElementById('chart-pagos-mp').getContext('2d');
            chartPagosMP = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ingresos MercadoPago',
                        data: [],
                        borderColor: '#00a0e6',
                        backgroundColor: 'rgba(0, 160, 230, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evoluci√≥n Diaria MercadoPago'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico 4: M√©todos de Pago
            const ctx4 = document.getElementById('chart-metodos-pago').getContext('2d');
            chartMetodosPago = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cantidad de Pagos',
                        data: [],
                        backgroundColor: '#9C27B0',
                        borderColor: '#7B1FA2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'M√©todos de Pago Utilizados'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function actualizarReportes() {
            if (mpConectado) {
                await cargarPagosMercadoPago();
                mostrarNotificacion('üìä Reportes actualizados con datos reales de MercadoPago');
            } else {
                mostrarNotificacion('‚ùå Conecta MercadoPago primero para obtener datos reales');
            }
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const titulo = mpConectado ? 'Reporte Ferreter√≠a (MercadoPago Real)' : 'Reporte Ferreter√≠a (Sin MercadoPago)';
            doc.setFontSize(20);
            doc.text(titulo, 20, 20);
            
            doc.setFontSize(12);
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-ES'), 20, 35);
            doc.text('Estado MP: ' + (mpConectado ? 'Conectado' : 'Desconectado'), 20, 45);
            
            if (mpConectado) {
                doc.text('Ambiente: ' + (environment === 'sandbox' ? 'Pruebas' : 'Producci√≥n'), 20, 55);
                doc.text('Pagos procesados: ' + pagosMercadoPago.filter(p => p.status === 'approved').length, 20, 65);
            }
            
            const stats = [
                '',
                'BALANCES:',
                '‚Ä¢ Balance Neto MP: ' + document.getElementById('balance-neto-mp').textContent,
                '‚Ä¢ Balance Neto Mostrador: ' + document.getElementById('balance-neto-mostrador').textContent,
                '‚Ä¢ Total Ingresos: ' + document.getElementById('total-ingresos').textContent,
                '‚Ä¢ Total Gastos: ' + document.getElementById('total-gastos').textContent,
                '',
                'ESTAD√çSTICAS MERCADOPAGO:',
                '‚Ä¢ Promedio diario MP: ' + document.getElementById('stat-promedio-mp').textContent,
                '‚Ä¢ Total pagos MP: ' + document.getElementById('stat-total-pagos').textContent,
                '‚Ä¢ Pago m√°s alto: ' + document.getElementById('stat-pago-alto').textContent,
                '‚Ä¢ √öltimo pago: ' + document.getElementById('stat-ultimo-pago').textContent
            ];
            
            let yPos = mpConectado ? 80 : 60;
            stats.forEach(stat => {
                doc.text(stat, 20, yPos);
                yPos += 8;
            });
            
            const filename = mpConectado ? 'reporte-mercadopago-' : 'reporte-local-';
            doc.save(filename + new Date().toISOString().split('T')[0] + '.pdf');
            
            mostrarNotificacion('üìÑ Reporte PDF descargado');
        }

        function mostrarNotificacion(mensaje) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 1rem;
                border-radius: 4px;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                max-width: 300px;
            `;
            notification.textContent = mensaje;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>
</body>
</html>