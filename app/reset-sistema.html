<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Reset Sistema - Control Ferreter√≠a</title>
    <link rel="stylesheet" href="styles-ferreteria.css">
    <style>
        .reset-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .reset-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .danger-box {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .success-box {
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .btn-large {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-large:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .status-info {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÑ Reset Sistema Ferreter√≠a</h1>
            <p>Herramientas de Backup y Reset Completo</p>
        </header>

        <div class="reset-container">
            <!-- Informaci√≥n del sistema actual -->
            <div class="reset-card">
                <h2>üìä Estado Actual del Sistema</h2>
                <div id="sistema-stats" class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-ingresos-mp">0</div>
                        <div class="stat-label">Ingresos MP</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-ventas">0</div>
                        <div class="stat-label">Ventas Mostrador</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-pagos-prov">0</div>
                        <div class="stat-label">Pagos Proveedores</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-pagos-efec">0</div>
                        <div class="stat-label">Pagos Efectivo</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total-registros">0</div>
                        <div class="stat-label">Total Registros</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-balance">$0</div>
                        <div class="stat-label">Balance Neto</div>
                    </div>
                </div>
            </div>

            <!-- Acciones de Backup -->
            <div class="reset-card">
                <h2>üíæ Gesti√≥n de Backups</h2>
                <p>Antes de hacer cualquier cambio, aseg√∫rate de tener un backup de tus datos.</p>
                
                <div class="btn-group">
                    <button class="btn-large btn-primary" onclick="crearBackupManual()">
                        üíæ Crear Backup Ahora
                    </button>
                    <button class="btn-large btn-success" onclick="exportarBackupActual()">
                        üì§ Exportar Backup
                    </button>
                    <button class="btn-large btn-primary" onclick="mostrarBackupsDetallado()">
                        üì¶ Ver Todos los Backups
                    </button>
                </div>

                <div id="backup-status" class="status-info" style="display: none;">
                    <h4>‚úÖ Backup Creado Exitosamente</h4>
                    <p id="backup-details"></p>
                </div>
            </div>

            <!-- Warning Box -->
            <div class="warning-box">
                <h3>‚ö†Ô∏è Importante - Lee Antes de Continuar</h3>
                <ul>
                    <li>El <strong>RESET COMPLETO</strong> borrar√° todos los datos del sistema</li>
                    <li>Se crear√° un backup autom√°tico antes del reset</li>
                    <li>Esta acci√≥n es <strong>IRREVERSIBLE</strong> una vez confirmada</li>
                    <li>El sistema quedar√° como reci√©n instalado</li>
                    <li>Podr√°s restaurar desde un backup si es necesario</li>
                </ul>
            </div>

            <!-- Reset Section -->
            <div class="reset-card">
                <h2>üîÑ Reset Completo del Sistema</h2>
                
                <div class="danger-box">
                    <h3>üö® ZONA PELIGROSA</h3>
                    <p>Esta acci√≥n eliminar√° TODOS los datos del sistema. Aseg√∫rate de tener un backup antes de continuar.</p>
                </div>

                <div class="btn-group">
                    <button class="btn-large btn-danger" onclick="confirmarResetCompleto()">
                        üîÑ INICIAR RESET COMPLETO
                    </button>
                </div>
            </div>

            <!-- Acciones Adicionales -->
            <div class="reset-card">
                <h2>üîß Herramientas Adicionales</h2>
                
                <div class="btn-group">
                    <button class="btn-large btn-primary" onclick="window.location.href='index.html'">
                        üè† Volver al Sistema
                    </button>
                    <button class="btn-large btn-success" onclick="verificarIntegridad()">
                        üîç Verificar Integridad
                    </button>
                    <button class="btn-large btn-primary" onclick="limpiarBackupsAntiguos()">
                        üßπ Limpiar Backups Antiguos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script-ferreteria.js"></script>
    <script src="sistema-backup-reset.js"></script>
    <script>
        let sistemaReset;

        document.addEventListener('DOMContentLoaded', function() {
            sistemaReset = new SistemaBackupReset();
            cargarEstadisticasActuales();
        });

        function cargarEstadisticasActuales() {
            try {
                const stats = calcularEstadisticasActuales();
                
                document.getElementById('stat-ingresos-mp').textContent = stats.ingresosMP;
                document.getElementById('stat-ventas').textContent = stats.ventasMostrador;
                document.getElementById('stat-pagos-prov').textContent = stats.pagosProveedores;
                document.getElementById('stat-pagos-efec').textContent = stats.pagosEfectivo;
                document.getElementById('stat-total-registros').textContent = stats.totalRegistros;
                document.getElementById('stat-balance').textContent = '$' + stats.balanceNeto.toLocaleString();
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        function calcularEstadisticasActuales() {
            const ingresosMP = JSON.parse(localStorage.getItem('ingresosMP') || '[]');
            const ventasMostrador = JSON.parse(localStorage.getItem('ventasMostrador') || '[]');
            const pagosProveedores = JSON.parse(localStorage.getItem('pagosProveedores') || '[]');
            const pagosEfectivo = JSON.parse(localStorage.getItem('pagosEfectivo') || '[]');

            const totalIngresos = 
                ingresosMP.reduce((sum, item) => sum + (item.montoNeto || 0), 0) +
                ventasMostrador.reduce((sum, item) => sum + (item.monto || 0), 0);

            const totalEgresos = 
                pagosProveedores.reduce((sum, item) => sum + (item.monto || 0), 0) +
                pagosEfectivo.reduce((sum, item) => sum + (item.monto || 0), 0);

            return {
                ingresosMP: ingresosMP.length,
                ventasMostrador: ventasMostrador.length,
                pagosProveedores: pagosProveedores.length,
                pagosEfectivo: pagosEfectivo.length,
                totalRegistros: ingresosMP.length + ventasMostrador.length + pagosProveedores.length + pagosEfectivo.length,
                balanceNeto: totalIngresos - totalEgresos
            };
        }

        function confirmarResetCompleto() {
            const stats = calcularEstadisticasActuales();
            
            const mensaje = `‚ö†Ô∏è CONFIRMACI√ìN DE RESET COMPLETO\n\n` +
                          `Datos que se borrar√°n:\n` +
                          `‚Ä¢ ${stats.ingresosMP} ingresos de MercadoPago\n` +
                          `‚Ä¢ ${stats.ventasMostrador} ventas de mostrador\n` +
                          `‚Ä¢ ${stats.pagosProveedores} pagos a proveedores\n` +
                          `‚Ä¢ ${stats.pagosEfectivo} pagos en efectivo\n` +
                          `‚Ä¢ Total: ${stats.totalRegistros} registros\n\n` +
                          `Balance actual: $${stats.balanceNeto.toLocaleString()}\n\n` +
                          `¬øEst√°s COMPLETAMENTE SEGURO?`;

            if (confirm(mensaje)) {
                const segundaConfirmacion = confirm(
                    'üî¥ √öLTIMA OPORTUNIDAD\n\n' +
                    'Esta acci√≥n es IRREVERSIBLE.\n' +
                    'Se crear√° un backup autom√°tico.\n\n' +
                    '¬øCONFIRMAS EL RESET COMPLETO?'
                );

                if (segundaConfirmacion) {
                    ejecutarResetCompleto();
                }
            }
        }

        function ejecutarResetCompleto() {
            const resultado = sistemaReset.resetCompleto();

            if (resultado.success) {
                alert('‚úÖ RESET COMPLETADO EXITOSAMENTE\n\n' + 
                      `Backup autom√°tico: ${resultado.backupCreado}\n\n` +
                      'El sistema est√° ahora en estado inicial.\n' +
                      'Ser√°s redirigido al sistema principal.');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } else {
                alert('‚ùå Error en el reset: ' + resultado.error);
            }
        }

        function mostrarBackupsDetallado() {
            const backups = sistemaReset.listarBackups();

            if (backups.length === 0) {
                alert('üì¶ No hay backups disponibles.\n\nCrea un backup antes de continuar.');
                return;
            }

            let mensaje = 'üì¶ BACKUPS DISPONIBLES:\n\n';
            backups.forEach((backup, index) => {
                const fecha = new Date(backup.fecha).toLocaleString('es-ES');
                mensaje += `${index + 1}. ${fecha}\n`;
                mensaje += `   üìä ${backup.estadisticas.totalRegistros} registros\n`;
                mensaje += `   üí∞ Balance: $${backup.estadisticas.balanceNeto.toLocaleString()}\n`;
                mensaje += `   üì¶ ${backup.tama√±o}\n\n`;
            });

            mensaje += 'Usa "Exportar Backup" para descargar un archivo de respaldo.';
            alert(mensaje);
        }

        function verificarIntegridad() {
            try {
                const claves = ['ingresosMP', 'ventasMostrador', 'pagosProveedores', 'pagosEfectivo'];
                let problemas = [];

                claves.forEach(clave => {
                    try {
                        const datos = JSON.parse(localStorage.getItem(clave) || '[]');
                        if (!Array.isArray(datos)) {
                            problemas.push(`${clave}: No es un array v√°lido`);
                        }
                    } catch (error) {
                        problemas.push(`${clave}: Error de JSON`);
                    }
                });

                if (problemas.length === 0) {
                    alert('‚úÖ INTEGRIDAD VERIFICADA\n\nTodos los datos est√°n en buen estado.');
                } else {
                    alert('‚ö†Ô∏è PROBLEMAS ENCONTRADOS:\n\n' + problemas.join('\n') + 
                          '\n\nConsidera hacer un reset si hay muchos errores.');
                }

            } catch (error) {
                alert('‚ùå Error verificando integridad: ' + error.message);
            }
        }

        function limpiarBackupsAntiguos() {
            const resultado = sistemaReset.limpiarBackupsAntiguos(3);
            
            if (resultado.success) {
                alert('‚úÖ ' + resultado.mensaje);
            } else {
                alert('‚ùå Error: ' + resultado.error);
            }
        }
    </script>
</body>
</html>